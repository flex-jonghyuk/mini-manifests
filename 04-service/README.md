# Service

Kubernetes의 `Service`는 특정 파드 집합에 대한 네트워크 접근을 추상화하고 제공하는 리소스입니다. 즉, 서비스는 파드에게 안정적인 IP 주소와 DNS 이름을 제공하여 파드 간의 연결 및 인터넷과의 연결을 용이하게 합니다.

## Service의 주요 기능:

1. **Service Discovery**: 파드에 대한 안정적인 IP 주소와 DNS 이름 제공
2. **Load Balancing**: 여러 파드에 걸친 요청을 균등하게 분산
3. **Service Endpoint Maintenance**: 파드의 가용성 변경에 따른 엔드포인트 동적 유지

## Service 타입:

Kubernetes의 `Service`는 파드에 대한 네트워크 요청을 추상화하고 로드밸런싱하는 데 사용되며, 여러 가지 타입을 제공합니다. 각 타입은 다양한 사용 사례에 맞춰 설계되었습니다.

### 1. ClusterIP

내부에만 연다

- **정의**: 서비스에 클러스터 내부에서만 접근 가능한 IP를 할당합니다.
- **사용 사례**: 클러스터 내부에서만 사용되어야 하는 서비스에 사용됩니다. 예를 들어, 데이터베이스나 내부 API 서버 등이 있습니다.
- **접근**: 클러스터 외부에서는 직접적인 접근이 불가능합니다.

### 2. NodePort

외부로 깐다

- **정의**: 모든 노드에서 동일한 포트를 통해 서비스에 접근할 수 있게 합니다. NodePort는 30000-32767 범위에서 동작합니다.
- **사용 사례**: 외부 시스템이나 사용자가 클러스터 노드의 IP 주소와 특정 포트를 사용하여 서비스에 접근해야 할 때 유용합니다.
- **접근**: `<노드의 IP>:<NodePort>`를 통해 서비스에 접근할 수 있습니다.
- 원한다면 특정 노드 포트를 지정할 수도 있습니다. 그렇지 않으면, Kubernetes가 자동으로 30000-32767 범위의 포트를 선택해서 할당해줍니다.

### 3. LoadBalancer

몬가... 클라우드 프로바이더랑 엮여서 뭔가 한다

- **정의**: 클라우드 제공자의 로드밸런서를 사용하여 서비스를 인터넷에 노출시킵니다. 클라우드 환경에서 동작하며, 해당 클라우드 제공자가 로드밸런싱 기능을 지원해야 합니다.
- **사용 사례**: 고가용성을 요구하는 웹 서비스나 API에 주로 사용됩니다.
- **접근**: 할당된 고정 IP 또는 DNS 이름을 통해 서비스에 접근합니다.

### 4. ExternalName

이 서비스로 클러스터 내부접근하면 CNAME레코드로 리다이렉트해준다.

```yaml
apiVersion: v1
kind: Service
metadata:
  name: external-service
spec:
  type: ExternalName
  externalName: some.external.service.com
```

- **정의**: 서비스를 클러스터 외부의 특정 도메인 이름으로 맵핑합니다. 이 타입은 CNAME 레코드를 반환하여 도메인에 리다이렉트합니다.
- **사용 사례**: 클러스터 외부의 서비스에 접근할 필요가 있을 때, 예를 들어 클러스터 내의 애플리케이션에서 외부 데이터베이스에 접근해야 하는 경우 유용합니다.
- **접근**: 지정된 외부 도메인 이름을 통해 서비스에 접근합니다.

클러스터 내에서 external-service.default.svc.cluster.local 같은 DNS 이름으로 접근할 경우, DNS 시스템은 해당 이름을 some.external.service.com 으로 리다이렉트(별칭 CNAME 리코드로 변환)합니다.

## 주요 옵션:

1. **selector**: 서비스가 트래픽을 전달할 파드를 선택하는 데 사용되는 레이블 선택자입니다.
2. **ports**: 서비스가 트래픽을 전달할 포트 및 대상 포트를 정의합니다.
3. **type**: 위에서 설명한 서비스 타입 (예: `ClusterIP`, `NodePort`, `LoadBalancer`, `ExternalName`)을 지정합니다.
4. **sessionAffinity**: 서비스에 도착하는 요청을 특정 파드에 "고정"시키는 기능입니다. 예를 들어, 특정 사용자의 모든 요청이 동일한 파드로 라우팅되도록 할 수 있습니다.
5. **externalIPs**: 서비스를 클러스터 외부의 특정 IP로 노출하려는 경우 사용합니다.
6. **loadBalancerIP**: 클라우드 로드 밸런서의 특정 IP 주소를 요청하려는 경우 사용합니다.

이 외에도 서비스 관련 다양한 설정과 옵션들이 있습니다. Kubernetes 공식 문서에서 자세한 스펙과 옵션들을 확인하실 수 있습니다.

## Q&A

### node port는 로드 밸런싱을 하지 않는가?

왜 우리는 팟을 늘리는걸까?

`LoadBalancer`와 `NodePort`는 Kubernetes 서비스의 두 가지 다른 타입입니다. 그러나 둘 다 트래픽을 여러 파드 사이에서 분산시킬 수 있습니다. 각 타입의 특징에 대해 좀 더 자세히 설명하겠습니다.

- NodePort: NodePort는 클러스터의 모든 노드에서 지정한 포트를 열고, 외부에서 들어오는 트래픽을 이 포트를 통해 특정 서비스로 라우팅합니다. 트래픽이 노드에 도착하면, 쿠버네티스 서비스가 파드 선택을 위한 로드 밸런싱을 수행하게 됩니다. 따라서 3개의 파드가 있으면, 트래픽은 이 3개의 파드 사이에서 균등하게 분산됩니다.
- LoadBalancer: LoadBalancer 타입의 서비스는 클라우드 프로바이더의 로드 밸런서를 사용합니다. 이 로드 밸런서는 트래픽을 클러스터의 여러 노드로 분산시킵니다. 그 후, 쿠버네티스 서비스가 트래픽을 적절한 파드로 라우팅합니다. 그래서 실제로 두 단계의 로드 밸런싱이 발생하게 됩니다.

요약하자면, NodePort와 LoadBalancer 모두 트래픽을 파드로 분산시키는 기능이 있습니다. 하지만 LoadBalancer는 클라우드 프로바이더의 로드 밸런서를 추가적으로 사용하여, 클러스터 외부에서 클러스터 내의 노드로 트래픽을 분산시키는 추가적인 로드 밸런싱 단계를 제공합니다.

### port mapping이 어떻게 되는건가?

- 서버가 listen하는 포트
- docker image에서 열어주는 포트(`EXPOSE`)
- 쿠버네티스의 port

서버가 3000번에서 listen하고 있고, docker에서는 3000번 포트를 expose하고 있다면 쿠버네티스에서는 다음과 같이 해줘야함

```yaml
ports:
  - protocol: TCP
    port: 8080 # 서비스에 접근하기 위한 포트
    targetPort: 3000 # 파드의 컨테이너 포트
```

이렇게 하면 서비스에 할당된 ip의 8080포트로 접근하면 컨테이너의 3000번 포트로 포워딩 된다고 말할 수 있음

도커에는 포트포워딩을 할 수 있는 옵션이 있는데, 쿠버네티스에서는 서버의 listen 포트와 도커가 열어주는 포트가 같아야 하는듯?

```shell
# 컨테이너 외부에서 접근을 8080포트로 하면 컨테이너의 80포트로 포워딩
docker run -p 8080:80 my-nginx-image
```

## 실습

- 서비스를 띄워보고 liveness probe 헬스체크를 해봅니다
- 로컬 호스트로 접근해봅니다 `minikube service myapp-service --url` -> 미니쿠베에서는 클러스터 IP를 로컬호스트로 띄워준다
